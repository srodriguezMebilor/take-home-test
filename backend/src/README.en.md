## Running the Backend

To build the backend, navigate to the `src` folder and run:  
```sh
dotnet build
```

To run all tests:  
```sh
dotnet test
```

To start the main API:  
```sh
cd Fundo.Applications.WebApi  
dotnet run
```

The following endpoint should return **200 OK**:  
```http
GET -> https://localhost:5001/loan
```

## Notes  

Feel free to modify the code as needed, but try to **respect and extend the current architecture**, as this is intended to be a replica of the Fundo codebase.


**Fundo - Loan Management System (Extended Edition)**

**By Sebastián Rodríguez** <sup>2</sup>

This project is a professional implementation of a loan management system, built upon the original **Fundo** codebase. The primary goal is to extend the base architecture to support high-concurrency environments and improve observability through modern telemetry.

**Architecture and Design Decisions**

**1\. Data Layer Decoupling (DI & IoC)**

**Dependency Injection** was implemented throughout the persistence infrastructure<sup>3</sup>.

- **Implementation:** The system depends on the IAppDbContext interface rather than the concrete AppDbContext class.
- **Benefit:** Facilitates **Unit Testing** (Mocking) and allows for switching database engines without impacting business logic<sup>4</sup>.

**2\. Encapsulation and Security (DTOs)**

The project utilizes **C# 12 Records** for data transfer (LoanDTO)<sup>555</sup>.

+1

- **Purpose:** Prevents exposing internal details (such as concurrency Timestamps) in API contracts.
- **Advantage:** Ensures data immutability and cleaner code.

**3\. Optimistic Concurrency Control**

To ensure balance integrity, an **Optimistic Concurrency** mechanism was implemented using **Concurrency Tokens**.

- **Technique:** Utilizes the RowVersion property managed by SQL Server to avoid heavy locking (Pessimistic Locking)<sup>666</sup>.

+1

- **Simulation:** A flag system in appsettings.json was integrated to simulate network latency and validate data collisions:

JSON

"FeatureManagement": {

"EnableConcurrencyTestDelay": true,

"ConcurrencyDelayMs": 2000

}

- **Justification:** This allows for controlled network latency simulation, facilitating the testing of data collisions and validating that the **RowVersion** mechanism responds correctly.

**4\. Robustness and Business Logic**

**Precondition Validation**

The system acts as a guardian of business rules, validating critical preconditions before any persistence occurs:

- **Loan Creation:** Validates minimum/maximum amounts and customer integrity.
- **Payment Processing:** Validates loan existence, ensures payment does not exceed the remaining balance, and verifies the loan is not already closed.

**5\. RESTful API Design and Status Codes**

Semantic HTTP responses were implemented for seamless Frontend integration:

| **Scenario** | **HTTP Code** | **Reason** |
| --- | --- | --- |
| **Successful Operation** | 200 OK | Resource processed or returned correctly. |
| **Resource Created** | 201 Created | Confirmation of new loan creation. |
| **Validation Error** | 400 Bad Request | Precondition failure (e.g., payment exceeds balance). |
| **Data Conflict** | 409 Conflict | Concurrency collision detected (RowVersion mismatch). |
| **Not Found** | 404 Not Found | Requested Loan ID does not exist. |

**Testing Strategy (xUnit & Integration Tests)**

A comprehensive suite of integration tests validates the end-to-end flow using **xUnit** and **WebApplicationFactory**<sup>7</sup>:

- **Data Integrity:** Ensures that the ID returned after creation matches the one generated by the database (Identity).
- **Mass Validation (Theory):** Uses \[Theory\] and InlineData to systematically test all API validation guards.
- **Critical Concurrency Test:** A specific test (MakePayment_SimultaneousUpdates_ShouldReturnConflict) triggers simultaneous requests to verify that the system correctly handles DbUpdateConcurrencyException, preventing **Race Conditions** and inconsistent balances.

**Structured Observability (Serilog + Seq)**

The default logging was replaced with a **Structured Logging** pipeline<sup>8</sup>.

- **Visualization:** Integrated with **Seq** to centralize and analyze logs, allowing for transaction tracking and SQL query detailing in real-time.

**Security Considerations**

- **Robust Validation:** Input validation at the application layer ensures data integrity.
- **Contract Protection (DTOs):** Immutable Records prevent over-posting attacks and hide the internal database structure.
- **Exception Handling:** Global error handling prevents leaking sensitive stack traces in HTTP responses.
- **Future Roadmap:** For production environments, the integration of **ASP.NET Core Identity with JWT** is planned to implement Role-Based Access Control (RBAC).

**Tech Stack**

- **Core:** .NET 8.0 (Web API) <sup>9</sup>
- **ORM:** Entity Framework Core (SQL Server) <sup>10</sup>
- **Database:** SQL Server 2022 (Dockerized) <sup>11</sup>
- **Logging:** Serilog & Seq (Dockerized) <sup>12</sup>
- **Tools:** Docker Compose, Swagger/OpenAPI <sup>13</sup>
- **Patterns:** Repository Pattern, DTOs with Records, Dependency Injection, Clean Architecture, DDD<sup>14</sup>.
- **Quality Assurance:** xUnit, Fluent Assertions<sup>15</sup>.

**Quick Start**

- **Spin up Infrastructure:** docker-compose up -d <sup>16</sup>
- **Run API:** dotnet run --project src/Fundo.Applications.WebApi
- **Explore:** Access Swagger UI at <http://localhost:53296/swagger>
